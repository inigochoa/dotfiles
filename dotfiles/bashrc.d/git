# ~/.bashrc.d/git

## Functions
### Clone a git repository and cd inside
gclone() {
  git clone "$1" && cd "$(basename "$1" .git)"
}

### Sync a repository with base remote
gsync() {
  local branch=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
  local current_branch=$(git rev-parse --abbrev-ref HEAD)
  local stashed=false

  echo "ðŸ”„ Synchronizing branch $branch between origin and base..."

  ## Save local changes
  if ! git diff --quiet; then
    echo "âš ï¸ There are uncommitted local changes. Saving with stash..."
    git stash push -m "auto: changes before gsync at $(date)"

    local stashed=true
  fi

  ## Checkout to the branch
  if [ "$current_branch" != "$branch" ]; then
    echo "ðŸ”€ Switching from '$current_branch' to '$branch'..."

    if ! git checkout "$branch"; then
      echo "âŒ Error switching to branch '$branch'"

      if [ true = "$stashed" ]; then
        git stash pop
      fi

      return 1
    fi
  fi

  ## Pull from origin
  echo "â¬‡ï¸ Pulling changes from origin/$branch..."
  if ! git pull origin "$branch"; then
    echo "âŒ Error pulling changes from origin/$branch"

    if [ true = "$stashed" ]; then
      git stash pop
    fi

    return 1
  fi

  ## Fetching from base
  echo "ðŸ” Fetching changes from base..."
  if ! git fetch base; then
    echo "âŒ Error fetching changes from base"

    if [ true = "$stashed" ]; then
      git stash pop
    fi

    return 1
  fi

  ## Merge from base
  echo "ðŸ”€ Merging changes from base/$branch..."
  if git merge "base/$branch"; then
    echo "âœ… Merge successful. Pushing changes to origin/$branch..."

    if git push origin "$branch"; then
      echo "ðŸŽ‰ Synchronization completed successfully!"
    else
      echo "âŒ Error pushing to origin/$branch"

      if [ true = "$stashed" ]; then
        git stash pop
      fi

      return 1
    fi
  else
    echo "âš ï¸ Conflicts detected during merge."
    echo -n "Do you want to open the editor to resolve conflicts? (y/n): "
    read answer

    if [[ "$answer" =~ ^[Yy]$ ]]; then
      echo "ðŸ”§ Opening editor..."
      code .
    else
      echo "ðŸ›‘ Operation aborted by user. Running git merge --abort"
      git merge --abort
    fi
  fi

  ## Recover changes from stash
  if [ true = "$stashed" ]; then
    echo "ðŸ“¦ Recovering previously saved changes..."
    git stash pop
  fi

  ## Revert to the original branch if it was different
  if [ "$current_branch" != "$branch" ]; then
    echo "ðŸ”™ Reverting to the original branch '$current_branch'..."
    git checkout "$current_branch"
  fi
}

## git-cliff - https://github.com/orhun/git-cliff
alias gitcliff="pnpx git-cliff@latest --output CHANGELOG.md --unreleased"

## onefetch - https://onefetch.dev/
if command -v onefetch >/dev/null 2>&1; then
  alias git-summary="onefetch"
  alias git-sm="onefetch"
  alias gsm="onefetch"
fi
